<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Login & Manajemen User</title>
<style>
:root {
  --bg-dark: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  --bg-light: linear-gradient(135deg,#dfe9f3,#ffffff);
  --card-dark: #1c2b36;
  --card-light: #fff;
  --text-dark: #fff;
  --text-light: #333;
}
body {
  font-family:"Segoe UI", Tahoma, sans-serif;
  background: var(--bg-dark);
  color: var(--text-dark);
  margin:0; padding:20px;
  display:flex; justify-content:center; align-items:center;
  min-height:100vh;
  transition: background 0.6s, color 0.6s;
}
.container {
  width:100%; max-width:1200px;
  background:var(--card-dark); color:var(--text-dark);
  border-radius:15px; padding:20px;
  box-shadow:0 8px 25px rgba(0,0,0,0.3);
  opacity:0; transform:translateY(30px);
  transition:all 0.6s ease;
}
.container.show { opacity:1; transform:translateY(0); }
h2{text-align:center;margin-bottom:20px;}
h3{margin:15px 0 10px;color:#00c6ff;}
form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:20px;}
input,select{padding:10px;border:1px solid #ccc;border-radius:8px;transition:border 0.3s;}
input:focus{border-color:#2575fc;outline:none;}
button{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.3s ease;}
.btn-primary{background:#2575fc;color:#fff;}
.btn-primary:hover{background:#1d5fd1;transform:scale(1.05);}
.btn-danger{background:#e74c3c;color:#fff;}
.btn-danger:hover{background:#c0392b;transform:scale(1.05);}
.btn-warning{background:#f39c12;color:#fff;}
.btn-warning:hover{background:#d68910;transform:scale(1.05);}
.user-table{width:100%;border-collapse:collapse;margin-top:10px;}
.user-table th,.user-table td{border:1px solid #444;padding:10px;text-align:center;}
.user-table th{background:#2575fc;color:#fff;}
.user-table tr{transition:background 0.3s;}
.user-table tr:hover{background:rgba(255,255,255,0.1);}
.hidden{display:none;}
.light-mode{background:var(--bg-light);color:var(--text-light);}
.light-mode .container{background:var(--card-light);color:var(--text-light);}
.light-mode .user-table th{background:#444;}
.toast{position:fixed;top:20px;right:20px;background:#2575fc;color:#fff;padding:10px 20px;border-radius:10px;opacity:0;transform:translateY(-20px);transition:all 0.5s ease;z-index:9999;}
.toast.show{opacity:1;transform:translateY(0);}
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- TOGGLE MODE -->
<button id="toggleMode" style="position:fixed;bottom:20px;right:20px;z-index:1000;" class="btn-primary">🌙 Mode</button>

<!-- LOGIN PAGE -->
<div class="container show" id="loginPage">
  <h2>🔐 Login Developer</h2>
  <form id="loginForm">
    <input type="text" id="loginEmail" placeholder="Username / Email" required>
    <input type="password" id="loginPassword" placeholder="Password" required>
    <button type="submit" class="btn-primary">Login</button>
  </form>
</div>

<!-- DASHBOARD PAGE -->
<div class="container hidden" id="dashboard">
  <h2>👨‍💻 Developer - Manajemen User</h2>

  <h3>🔑 Ganti Password</h3>
  <form id="changePassForm">
    <input type="password" id="newPassword" placeholder="Password Baru" required>
    <button type="submit" class="btn-primary">Ganti Password</button>
  </form>

  <h3>➕ Tambah User Baru</h3>
  <form id="addUserForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="text" id="password" placeholder="Password" required>
    <select id="tokenSelect" required></select>
    <input type="text" id="ibu" placeholder="Nama Ibu Kandung" required>
    <select id="isAdmin">
      <option value="false">User Biasa</option>
      <option value="true">Admin</option>
    </select>
    <button type="submit" class="btn-primary">Tambah User</button>
  </form>

  <h3>📋 Daftar User</h3>
  <table class="user-table" id="userTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Password</th>
        <th>Token</th>
        <th>Nama Ibu</th>
        <th>Admin?</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>🔑 Manajemen Token</h3>
  <form id="addTokenForm">
    <input type="text" id="newToken" placeholder="Nama Token Baru" required>
    <button type="submit" class="btn-primary">Tambah Token</button>
  </form>
  <table class="user-table" id="tokenTable">
    <thead>
      <tr>
        <th>Token</th>
        <th>Jumlah User</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// === Firebase Config ===
const firebaseConfig={ databaseURL:"https://esp32-3a6dd-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// Default akun developer
const defaultUserId="zaki5go".replace(/\W/g,"_");
db.ref("users/"+defaultUserId).get().then(snap=>{
  if(!snap.exists()){
    db.ref("users/"+defaultUserId).set({
      email:"zaki5go",
      password:"miftahuddin9",
      token:"developer",
      ibu:"default",
      isAdmin:true
    });
    db.ref("panel/developer").set(true);
  }
});

// === Toast ===
function showToast(msg,color="#2575fc"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.background=color;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),3000);
}

// === LOGIN ===
document.getElementById("loginForm").addEventListener("submit", e=>{
  e.preventDefault();
  const email=document.getElementById("loginEmail").value.trim();
  const pass=document.getElementById("loginPassword").value.trim();
  const userId=email.replace(/\W/g,"_");
  db.ref("users/"+userId).get().then(snap=>{
    if(snap.exists()){
      const u=snap.val();
      if(u.password===pass){
        showToast("✅ Login berhasil!","green");
        document.getElementById("loginPage").classList.add("hidden");
        const dash=document.getElementById("dashboard");
        dash.classList.remove("hidden");
        setTimeout(()=>dash.classList.add("show"),50);
        loadAllUsers();
        loadAllTokens();
      } else {
        showToast("❌ Password salah!","red");
      }
    } else {
      showToast("❌ User tidak ditemukan!","red");
    }
  });
});

// === GANTI PASSWORD ===
document.getElementById("changePassForm").addEventListener("submit", e=>{
  e.preventDefault();
  const newPass=document.getElementById("newPassword").value.trim();
  if(!newPass){ showToast("⚠️ Password tidak boleh kosong!","orange"); return; }
  db.ref("users/"+defaultUserId).update({password:newPass}).then(()=>{
    showToast("🔑 Password berhasil diganti!","green");
    document.getElementById("changePassForm").reset();
  });
});

// === TAMBAH USER ===
document.getElementById("addUserForm").addEventListener("submit", e=>{
  e.preventDefault();
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const token=document.getElementById("tokenSelect").value;
  const ibu=document.getElementById("ibu").value.trim();
  const isAdmin=document.getElementById("isAdmin").value==="true";
  if(!email||!password||!token||!ibu){ showToast("⚠️ Lengkapi semua data!","orange"); return; }
  const userId=email.replace(/\W/g,"_");
  db.ref("users/"+userId).set({email,password,token,ibu,isAdmin}).then(()=>{
    showToast("✅ User berhasil ditambahkan!","green");
    document.getElementById("addUserForm").reset();
    loadAllUsers(); loadAllTokens();
  });
});

// === LOAD USER ===
function loadAllUsers(){
  const tbody=document.querySelector("#userTable tbody");
  tbody.innerHTML="";
  db.ref("users").get().then(snap=>{
    if(snap.exists()){
      const users=snap.val();
      for(const key in users){
        const u=users[key];
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${u.email}</td>
          <td>${u.password}</td>
          <td>${u.token||"-"}</td>
          <td>${u.ibu||"-"}</td>
          <td>${u.isAdmin?"✅":"❌"}</td>
          <td>
            <button class="btn-warning" onclick="toggleAdmin('${u.email}',${u.isAdmin})">
              ${u.isAdmin?"Jadikan User":"Jadikan Admin"}
            </button>
            <button class="btn-danger" onclick="deleteUser('${u.email}')">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    } else {
      tbody.innerHTML=`<tr><td colspan="6">Belum ada user</td></tr>`;
    }
  });
}

// === HAPUS USER ===
function deleteUser(email){
  if(confirm("Yakin ingin menghapus user: "+email+" ?")){
    const userId=email.replace(/\W/g,"_");
    db.ref("users/"+userId).remove().then(()=>{
      showToast("🗑️ User "+email+" berhasil dihapus!","red");
      loadAllUsers(); loadAllTokens();
    });
  }
}

// === TOGGLE ADMIN ===
function toggleAdmin(email,isAdmin){
  const userId=email.replace(/\W/g,"_");
  db.ref("users/"+userId).update({isAdmin:!isAdmin}).then(()=>{
    showToast("🔄 Status admin diubah!","blue");
    loadAllUsers();
  });
}

// === TOKEN ===
// Tambah Token ke /panel
document.getElementById("addTokenForm").addEventListener("submit", e=>{
  e.preventDefault();
  const token=document.getElementById("newToken").value.trim();
  if(!token){ showToast("⚠️ Token tidak boleh kosong!","orange"); return; }
  db.ref("panel/"+token).set(true).then(()=>{
    showToast("✅ Token "+token+" berhasil ditambahkan!","green");
    document.getElementById("addTokenForm").reset();
    loadAllTokens();
  });
});

// Load Token dari /panel
function loadAllTokens(){
  const tbody=document.querySelector("#tokenTable tbody");
  const select=document.getElementById("tokenSelect");
  tbody.innerHTML=""; select.innerHTML="";
  db.ref("panel").get().then(snap=>{
    if(snap.exists()){
      const tokens=snap.val();
      for(const t in tokens){
        countUsersByToken(t).then(jumlah=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${t}</td>
            <td>${jumlah} user</td>
            <td><button class="btn-danger" onclick="deleteToken('${t}')">Hapus Token</button></td>
          `;
          tbody.appendChild(tr);
        });
        const opt=document.createElement("option");
        opt.value=t; opt.textContent=t;
        select.appendChild(opt);
      }
    } else {
      tbody.innerHTML=`<tr><td colspan="3">Belum ada token</td></tr>`;
    }
  });
}

// Hitung jumlah user per token
function countUsersByToken(token){
  return db.ref("users").get().then(snap=>{
    if(snap.exists()){
      let count=0;
      const users=snap.val();
      for(const key in users){
        if(users[key].token===token) count++;
      }
      return count;
    }
    return 0;
  });
}

// Hapus Token dari /panel
function deleteToken(token){
  if(token==="developer"){ showToast("⚠️ Token ini tidak bisa dihapus!","orange"); return; }
  if(confirm("Yakin ingin menghapus token: "+token+" ?")){
    db.ref("panel/"+token).remove();
    db.ref("users").get().then(snap=>{
      if(snap.exists()){
        const users=snap.val();
        for(const key in users){
          if(users[key].token===token){
            db.ref("users/"+key+"/token").remove();
          }
        }
      }
    });
    showToast("🗑️ Token "+token+" berhasil dihapus!","red");
    loadAllTokens(); loadAllUsers();
  }
}

// === TOGGLE MODE ===
document.getElementById("toggleMode").addEventListener("click",()=>{
  document.body.classList.toggle("light-mode");
});
</script>
</body>
</html>
